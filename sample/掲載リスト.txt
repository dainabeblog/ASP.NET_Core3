ASP .NET Core入門


掲載リスト




















リスト6-1
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.ComponentModel.DataAnnotations;


namespace SampleAPIApp.Models
{
    public class Product
    {
        public int ProductId { get; set; }
        [Required]
        public string Name { get; set; }
        [Required]
        [DataType(DataType.Currency)]
        public int Price { get; set; }
        public string description { get; set; }
    }
}




リスト6-2
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();


    services.AddDbContext<SampleAPIAppContext>
            (options => options.UseSqlServer(
            Configuration.GetConnectionString("SampleAPIAppContext")));
}




リスト6-3
[HttpGet]
public async Task<ActionResult<IEnumerable<Product>>> GetProduct()
{
    return await _context.Product.ToListAsync();
}




リスト6-4
[HttpGet("{id}")]
public async Task<ActionResult<Product>> GetProduct(int id)
{
    var product = await _context.Product.FindAsync(id);


    if (product == null)
    {
        return NotFound();
    }


    return product;
}




リスト6-5
[HttpPut("{id}")]
public async Task<IActionResult> PutProduct(int id, Product product)
{
    if (id != product.ProductId)
    {
        return BadRequest();
    }
    _context.Entry(product).State = EntityState.Modified;
    try
    {
        await _context.SaveChangesAsync();
    }
    catch (DbUpdateConcurrencyException)
    {
        if (!ProductExists(id))
        {
            return NotFound();
        }
        else
        {
            throw;
        }
    }
    return NoContent();
}




リスト6-6
[HttpPost]
public async Task<ActionResult<Product>> PostProduct(Product product)
{
    _context.Product.Add(product);
    await _context.SaveChangesAsync();


    return CreatedAtAction("GetProduct", new { id = product.ProductId }, product);
}




リスト6-7
[HttpDelete("{id}")]
public async Task<ActionResult<Product>> DeleteProduct(int id)
{
    var product = await _context.Product.FindAsync(id);
    if (product == null)
    {
        return NotFound();
    }


    _context.Product.Remove(product);
    await _context.SaveChangesAsync();


    return product;
}




リスト6-8
public void ConfigureServices(IServiceCollection services)
{
    services.AddRazorPages();
    services.AddServerSideBlazor();
    services.AddSingleton<WeatherForecastService>();
}




リスト6-9
app.UseEndpoints(endpoints =>
{
    endpoints.MapBlazorHub();
    endpoints.MapFallbackToPage("/_Host");
});




リスト6-10
<app>
    @(await Html.RenderComponentAsync<App>(RenderMode.ServerPrerendered))
</app>




リスト6-11
<Router AppAssembly="@typeof(Program).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
    </Found>
    <NotFound>
        <LayoutView Layout="@typeof(MainLayout)">
            <p>Sorry, there's nothing at this address.</p>
        </LayoutView>
    </NotFound>
</Router>




リスト6-12
@inherits LayoutComponentBase


<div class="sidebar">
    <NavMenu />
</div>


<div class="main">
    <div class="top-row px-4">
        <a href="https://docs.microsoft.com/en-us/aspnet/" 
                target="_blank">About</a>
    </div>


    <div class="content px-4">
        @Body
    </div>
</div>




リスト6-13
@page "/counter"


<h1>Counter</h1>
<p>Current count: @currentCount</p>
<button class="btn btn-primary" 
        @onclick="IncrementCount">Click me</button>


@code {
    int currentCount = 0;


    void IncrementCount()
    {
        currentCount++;
    }
}




リスト6-14
@page "/sample"


<h1>Sample</h1>


<p class="h3">Total: @total</p>
<div class="form-row">
    <input type="number" @bind="val" class="form-control col-9" />
    <button @onclick="Calc" class="btn btn-primary col">Click</button>
</div>


@code {
    int val = 0;
    int total = 0;


    void Calc()
    {
        total = 0;
        for (var i = 0;i <= val;i++)
        {
            total += i;
        }
    }
}




リスト6-15
<li class="nav-item px-3">
    <NavLink class="nav-link" href="sample">
        <span class="oi oi-badge" aria-hidden="true"></span> Sample
    </NavLink>
</li>




リスト6-16
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.ComponentModel.DataAnnotations;


namespace SampleBlazorApp.Data
{
    public class Mydata
    {
        [Required]
        public string Name { get; set; }
        public string Password { get; set; }
        [EmailAddress]
        public string Mail { get; set; }


        public override string ToString()
        {
            return "[" + Name + " (" + Password + ") " + Mail + "]";
        }
    }
}




リスト6-17
@page "/sample"
@using SampleBlazorApp.Data


<h1>Sample</h1>


<p class="h3">@message</p>


<EditForm Model="@mydata" OnValidSubmit="@doAction">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="form-group">Name
        <InputText id="name" @bind-Value="@mydata.Name" 
                   class="form-control" />
    </div>
    <div class="form-group">Password
        <InputText type="password" id="password" 
                   @bind-Value="@mydata.Password" 
                   class="form-control" />
    </div>
    <div class="form-group">Mail
        <InputText id="mail" @bind-Value="@mydata.Mail" 
                   class="form-control" />
    </div>
    <button type="submit" class="btn btn-primary">
        Click</button>
</EditForm>


@code {
    private Mydata mydata = new Mydata();
    private string message = "Please input form:";


    private void doAction()
    {
        message = mydata.ToString();
    }
}




リスト6-18
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <base href="%PUBLIC_URL%/" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json">
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico">
    <title>SampleReactApp</title>
  </head>
  <body>
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>
    <div id="root"></div>
  </body>
</html>




リスト6-19
import 'bootstrap/dist/css/bootstrap.css';
import React from 'react';
import ReactDOM from 'react-dom';
import { BrowserRouter } from 'react-router-dom';
import App from './App';
import registerServiceWorker from './registerServiceWorker';


const baseUrl = document.getElementsByTagName('base')[0].getAttribute('href');
const rootElement = document.getElementById('root');


ReactDOM.render(
  <BrowserRouter basename={baseUrl}>
    <App />
  </BrowserRouter>,
  rootElement);


registerServiceWorker();




リスト6-20
import React, { Component } from 'react';
import { Route } from 'react-router';
import { Layout } from './components/Layout';
import { Home } from './components/Home';
import { FetchData } from './components/FetchData';
import { Counter } from './components/Counter';


import './custom.css'


export default class App extends Component {
  static displayName = App.name;


  render () {
    return (
      <Layout>
        <Route exact path='/' component={Home} />
        <Route path='/counter' component={Counter} />
        <Route path='/fetch-data' component={FetchData} />
      </Layout>
    );
  }
}




リスト6-21
import React, { Component } from 'react';
import { Container } from 'reactstrap';
import { NavMenu } from './NavMenu';


export class Layout extends Component {
  static displayName = Layout.name;


  render () {
    return (
      <div>
        <NavMenu />
        <Container>
          {this.props.children}
        </Container>
      </div>
    );
  }
}




リスト6-22
import React, { Component } from 'react';


export class Counter extends Component {
  static displayName = Counter.name;


  constructor(props) {
    super(props);
    this.state = { currentCount: 0 };
    this.incrementCounter = this.incrementCounter.bind(this);
  }


  incrementCounter() {
    this.setState({
      currentCount: this.state.currentCount + 1
    });
  }


  render() {
    return (
      <div>
        <h1>Counter</h1>


        <p>This is a simple example of a React component.</p>


        <p aria-live="polite">Current count: 
                <strong>{this.state.currentCount}</strong></p>


        <button className="btn btn-primary" 
                onClick={this.incrementCounter}>Increment</button>
      </div>
    );
  }
}




リスト6-23
import React, { Component } from 'react';


export class FetchData extends Component {
  static displayName = FetchData.name;


  constructor(props) {
    super(props);
    this.state = { forecasts: [], loading: true };
  }


  componentDidMount() {
    this.populateWeatherData();
  }


  static renderForecastsTable(forecasts) {
    return (
      <table className='table table-striped' aria-labelledby="tabelLabel">
        ……forecastsデータを元にテーブルを生成する……
      </table>
    );
  }


  render() {
    let contents = this.state.loading
      ? <p><em>Loading...</em></p>
      : FetchData.renderForecastsTable(this.state.forecasts);


    return (
      <div>
        <h1 id="tabelLabel" >Weather forecast</h1>
        <p>This component demonstrates fetching data from the server.</p>
        {contents}
      </div>
    );
  }


  async populateWeatherData() {
    const response = await fetch('weatherforecast');
    const data = await response.json();
    this.setState({ forecasts: data, loading: false });
  }
}




リスト6-24
[HttpGet]
public IEnumerable<WeatherForecast> Get()
{
    var rng = new Random();
    return Enumerable.Range(1, 5).Select(index => new WeatherForecast
    {
        Date = DateTime.Now.AddDays(index),
        TemperatureC = rng.Next(-20, 55),
        Summary = Summaries[rng.Next(Summaries.Length)]
    })
    .ToArray();
}




リスト7-1
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));


    // ☆Identityの追加
    services.AddDefaultIdentity<IdentityUser>(options => 
        options.SignIn.RequireConfirmedAccount = true)
            .AddEntityFrameworkStores<ApplicationDbContext>();


    services.AddRazorPages();
}




リスト7-2
app.UseAuthentication();
app.UseAuthorization();




リスト7-3
public class ApplicationDbContext : IdentityDbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options)
    {
    }
}




リスト7-4
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));


    services.AddDefaultIdentity<IdentityUser>(options => 
        options.SignIn.RequireConfirmedAccount = false)
            .AddEntityFrameworkStores<ApplicationDbContext>();


    services.AddRazorPages().AddRazorPagesOptions(options =>
        {
            options.Conventions.AuthorizePage("/Privacy");
        });
}


リスト7-5
// using Microsoft.AspNetCore.Authorization; 追記


[Authorize]
public IActionResult Privacy()
{
    return View();
}




リスト7-6
@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}


<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://docs.microsoft.com/aspnet/core">
        building Web apps with ASP.NET Core</a>.</p>
    <!--☆以下、追記-->
    <p class="h4">ID: 
        @(User.Identity.Name==null ? "no-data" : User.Identity.Name)
        @(User.Identity.IsAuthenticated + "/" 
                + User.Identity.AuthenticationType)</p>
</div>




リスト7-7
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));


    services.AddDefaultIdentity<IdentityUser>(options => 
        options.SignIn.RequireConfirmedAccount = false)
            .AddEntityFrameworkStores<ApplicationDbContext>();


    // ☆Google認証の追加
    services.AddAuthentication()
        .AddGoogle(options =>
        {
            IConfigurationSection googleAuthNSection =
                Configuration.GetSection("Authentication:Google");


            options.ClientId = googleAuthNSection["ClientId"];
            options.ClientSecret = googleAuthNSection["ClientSecret"];
        });


    services.AddRazorPages();
}




リスト7-8
private static void Hello(IApplicationBuilder app)
{
    app.Run(async context =>
    {
        await context.Response.WriteAsync("Hello!");
    });
}


private static void Bye(IApplicationBuilder app)
{
    app.Run(async context =>
    {
        await context.Response.WriteAsync("Good-Bye!");
    });
}




リスト7-9
app.Map("/map1", Hello);
app.Map("/map2", Bye);




リスト7-10
app.Map("/map1", Hello);
app.Run(async context =>
{
    await context.Response.WriteAsync("Run!");
});
app.Map("/map2", Bye);




リスト7-11
app.Map("/map1", Hello);
app.Use(async (context , next) =>
{
    await context.Response.WriteAsync("Use 1 !");
    await next();
});
app.Map("/map2", Bye);




リスト7-12
// using Microsoft.AspNetCore.Http; // 追記


public class SampleMiddleware
{
    private readonly RequestDelegate _next;


    public SampleMiddleware(RequestDelegate next)
    {
        _next = next;
    }


    public async Task InvokeAsync(HttpContext context)
    {
        SampleData data = new SampleData(
                "YAMADA-Taro", "taro@yamada", "999-9999");
        context.Session.SetString("SampleData", data.ToString());
        await _next(context);
    }
}


public class SampleData
{
    public string Name { get; set; }
    public string Mail { get; set; }
    public string Tel { get; set; }


    public SampleData(string name, string mail, string tel)
    {
        Name = name;
        Mail = mail;
        Tel = tel;
    }


    public override string ToString()
    {
        return "{ " + Name + ", " + Mail + ", " + Tel + " }";
    }
}




リスト7-13
public static class SampleMiddlewareExtensions
{
    public static IApplicationBuilder UseSample(
        this IApplicationBuilder builder)
    {
        return builder.UseMiddleware<SampleMiddleware>();
    }
}




リスト7-14
services.AddSession();




リスト7-15
app.UseSession();
app.UseSample();




リスト7-16
using Microsoft.AspNetCore.Mvc.RazorPages;


namespace SampleAuthApp.Pages
{
    public class IndexModel : PageModel
    {
        private readonly ILogger<IndexModel> _logger;
        public string SampleData { get; set; };


        public IndexModel(ILogger<IndexModel> logger)
        {
            _logger = logger;
        }


        public void OnGet()
        {
            SampleData = HttpContext.Session.GetString("SampleData");
        }


    }
}




リスト7-17
@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}


<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p class="h4">@Model.SampleData</p>
</div>




リスト7-18
// インターフェイス
public interface ISampleDependency
{
    public SampleData getData();
}


// 実装クラス
public class SampleDependency : ISampleDependency
{
    private List<SampleData> _data;


    public SampleDependency()
    {
        _data = new List<SampleData>();
        _data.Add(new SampleData("YAMADA-Taro", "taro@yamda", "999-9999"));
        _data.Add(new SampleData("Tanaka-Hanako", "hanako@flwer", "888-888"));
        _data.Add(new SampleData("Ito-Sachiko", "sachico@happy", "777-7777"));
        _data.Add(new SampleData("Oda-mami", "mami@mumemo", "666-6666"));
        _data.Add(new SampleData("Nakamura-Jiro", "jiro@change", "555-5555"));
    }


    public SampleData getData()
    {
        int n = new Random().Next(_data.Count());
        return _data[n];
    }
}




リスト7-19
services.AddScoped<ISampleDependency, SampleDependency>();




リスト7-20
services.AddSingleton<ISampleDependency, SampleDependency>();




リスト7-21
using Microsoft.AspNetCore.Mvc.RazorPages;


namespace SampleAuthApp.Pages
{
    public class IndexModel : PageModel
    {
        private ISampleDependency _sample;
        public string SampleData;


        public IndexModel(ISampleDependency sample)
        {
            _sample = sample;
        }


        public void OnGet()
        {
            SampleData = _sample.getData().ToString();
        }


    }
}




リスト7-22
using System.Threading.Tasks;
using Microsoft.AspNetCore.Razor.TagHelpers;


namespace SampleAuthApp.TagHelpers
{
    public class SampleTagHelper : TagHelper
    {
        public override void Process(TagHelperContext context, TagHelperOutput output)
        {
            output.TagName = "h3";
            output.Content.SetContent("This is Sample Tag Helper!!");
        }
    }
}




リスト7-23
@using Microsoft.AspNetCore.Identity
@using SampleAuthApp
@using SampleAuthApp.Data
@using SampleAuthApp.TagHelpers // ☆


@namespace SampleAuthApp.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers


@addTagHelper *, SampleAuthApp // ☆




リスト7-24
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <sample></sample>
</div>




リスト7-25
using System.Threading.Tasks;
using Microsoft.AspNetCore.Razor.TagHelpers;


namespace SampleAuthApp.TagHelpers
{
    public class SampleTagHelper : TagHelper
    {
        public override async Task ProcessAsync(TagHelperContext context, 
                TagHelperOutput output)
        {
            output.TagName = "h3";
            TagHelperContent child = await output.GetChildContentAsync();
            string content = child.GetContent();
            output.Content.SetHtmlContent(content.ToUpper());
        }
    }
}




リスト7-26
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <sample>This is <span style="color:red">
        Sample</span>.</sample>
</div>




リスト7-27
using System.Threading.Tasks;
using Microsoft.AspNetCore.Razor.TagHelpers;


namespace SampleAuthApp.TagHelpers
{
    public class SampleTagHelper : TagHelper
    {
        public string color { get; set; }
        public string bgColor { get; set; }


        public override async Task ProcessAsync(TagHelperContext context, 
                TagHelperOutput output)
        {
            output.TagName = "h3";
            string c = color != null ? color : "black";
            string bc = bgColor != null ? bgColor : "white";
            string style = "color:" + c + "; background:" + bc;
            output.Attributes.SetAttribute("style", style);
            TagHelperContent child = await output.GetChildContentAsync();
            string content = child.GetContent();
            output.Content.SetHtmlContent(content.ToUpper());
        }
    }
}




リスト7-28
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <sample>Plain sample.</sample>
    <sample color="magenta">Color sample</sample>
    <sample bg-color="yellow">Bg sample</sample>
    <sample color="white" bg-color="blue">Both sample</sample>
</div>




リスト7-29
using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Razor.TagHelpers;


namespace SampleAuthApp.TagHelpers
{
    public class SampleTagHelper : TagHelper
    {
        public List<string> items { get; set; }


        public override void Process(TagHelperContext context, 
                TagHelperOutput output)
        {
            if (items == null)
            {
                output.TagName = "p";
                output.Content.SetContent("*** no-data ***");
                return;
            }
            output.TagName = "ul";
            output.Attributes.SetAttribute("style", "text-align:left; font-size:20pt;");
            output.Content.Clear();


            foreach (var item in items)
            {
                output.Content.AppendHtml("<li>" + item + "</li>");
            }
        }
    }
}




リスト7-30
@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";


    var data = new List<string>();
    data.Add("One");
    data.Add("Two");
    data.Add("Three");
    data.Add("Four");
    data.Add("Five");
}


<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <sample items="@data"></sample>
</div>




リスト7-31
using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Razor.TagHelpers;


namespace SampleAuthApp.TagHelpers
{
    [HtmlTargetElement(Attributes = "sample")]
    public class SampleTagHelper : TagHelper
    {
        public override void Process(TagHelperContext context, 
                TagHelperOutput output)
        {
            var attr = new TagHelperAttribute("sample");
            output.Attributes.TryGetAttribute("sample", out attr);
            output.Attributes.RemoveAll("sample");
            output.Attributes.SetAttribute("style", "background-color:" + attr.Value);
        }
    }
}




リスト7-32
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <div class="h3">
        <p>
            This is <span sample="yellow">
                Sample Attribute
            </span>. ok?
        </p>
        <p>
            これは、<span sample="red">
                サンプルの属性
            </span>を使った例です。
        </p>
    </div>
</div>




リスト7-33
// using System.ComponentModel.DataAnnotations; // 追記


public class FormData
{
    [Required]
    public string Name { get; set; }
    public string Message { get; set; }


    public FormData()
    {
        Name = "";
        Message = "";
    }


    public FormData(string name, string msg)
    {
        Name = name;
        Message = msg;
    }
        public override string ToString()
    {
        return "{ " + Name + ", \"" + Message + "\" }";
    }
}




リスト7-34
public class MsgAttribute : ValidationAttribute
{


    protected override ValidationResult IsValid(
            object value, ValidationContext validationContext)
    {
        string val = (string)value;
            
        if (val == null)
        {
            return new ValidationResult("NULL STRING!");
        }
        return ValidationResult.Success;
    }


}




リスト7-35
[Msg]
public string Message { get; set; }




リスト7-36
public class IndexModel : PageModel
{
    [BindProperty]
    public FormData sampleData { get; set; }
    public string msg;


    public void OnGet()
    {
        msg = "input form:";
    }


    public IActionResult OnPost()
    {
        if (!ModelState.IsValid)
        {
            msg = "re-input form:";
        } else
        {
            msg = sampleData.ToString();
        }
        return Page();
    }


}




リスト7-37
@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}


<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <div class="text-left">
        <p class="h4 mb-4">@Model.msg</p>
        <form asp-page="Index">
            <div asp-validation-summary="All" 
                    class="text-danger"></div>
            <div><input asp-for="sampleData.Name" 
                    class="form-control" /></div>
            <div><input asp-for="sampleData.Message" 
                    class="form-control" /></div>
            <div><input type="submit" 
                    class="btn btn-primary" /></div>
        </form>
    </div>
</div>




リスト7-38
public class MsgAttribute : ValidationAttribute
{


    public int Min { get; set; }
    public string Ban { get; set; }


    protected override ValidationResult IsValid(
            object value, ValidationContext validationContext)
    {
        string val = (string)value;
            
        if (val == null)
        {
            return new ValidationResult("NULL STRING!");
        }
        if (val.Length < Min)
        {
            return new ValidationResult("TOOOO SHORT.");
        }
        if (val.Trim().ToUpper().Contains(Ban.Trim().ToUpper()))
        {
            return new ValidationResult("INCLUDE BAN-WORD.");
        }


        return ValidationResult.Success;
    }
}




リスト7-39
[Msg(Min = 5, Ban = ".NET")]
public string Message { get; set; }




リスト7-40
public class MsgAttribute : ValidationAttribute
{
    public int Min { get; set; }
    public string Ban { get; set; }


    protected override ValidationResult IsValid(
            object value, ValidationContext validationContext)
    {
        string val = (string)value;


        if (val == null)
        {
            return new ValidationResult(GetErrorMessage("NULL STRING!"));
        }
        if (val.Length < Min)
        {
            return new ValidationResult(GetErrorMessage("TOOOO SHORT."));
        }
        if (val.Trim().ToUpper().Contains(Ban.Trim().ToUpper()))
        {
            return new ValidationResult(GetErrorMessage("INCLUDE BAN-WORD."));
        }


        return ValidationResult.Success;
    }


    public string GetErrorMessage(string err)
    {
        return ErrorMessage != null ? ErrorMessage : err;
    }
}




リスト7-41
[Required(ErrorMessage ="必須項目です。")]
public string Name { get; set; }


[Msg(Min = 5, Ban = ".NET", ErrorMessage = "５文字以上で .NET を含まないメッセージが必要です。")]
public string Message { get; set; }